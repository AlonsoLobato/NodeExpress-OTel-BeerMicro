## Microservice architecture observed with Otel
Distributed architecture consisting on three microservices, `inventory-service` (running on port 3000), `bar-service` (running on port 3001), and `brewery-service` (running on port 3002) which communicate with each other using RabbitMQ. 

The traces generated by the interaction between the services is observed using OpenTelemetry (OTel) SDK and autoinstrumentation, and can be visualized via the Jaeger UI.

### Statement of intention
This is a personal side project made with the intention of learning OpenTelemetry observability solutions for distributed systems.

### Brief explanation of the architecture pipeline
`brewery-service` fetches a new random beer item from an external API, and sends it to `inventory-service` for storage in database. 

`bar-service` communicate with `inventory-service` to fetch full list of available beers (bar-menu) in the database. 

The communication from `brewery-service` and `bar-service` with `inventory-service` and viceversa, is made using RabbitMQ message queues.

### Project structure
NodeExpress-OTel-BeerMicro
- bar-service
  - routes
    - `bar-api.js`
  - `index.js`
  - `package.json`
- brewery-service
  - routes
    - `brewery-api.js`
  - `index.js`
  - `package.json`
- inventory-service
  - Models
    - DataAccess
      - `InventoryRepository.js`
    - `BeerModel.js`
  - `index.js`
  - `package.json`
- `package.json`
- `tracer.js`
- `docker-compose.yml`
- `collector-config.yml`
- `README.md`      

### Prerequisites
Before running the application, make sure you have the following dependencies installed:

1. NodeJS (v18.13.0)
```bash
# Verify NodeJS version
node -v
```
2. NPM (v8.19.3)
```bash
# Verify NPM version
npm -v
```

3. Docker desktop - [install from here](https://docs.docker.com/desktop/install/mac-install/)

4. MongoDB database instance (or MongoDB Atlas cluster). Create a `.env` file and add a `MONGODB_URI` variable that references your MongoDB database connection string, including your databse username and password.

### Installation and usage
1. Clone the repository (`git clone`)
2. From the root directory execute `npm install`, so the OTel dependencies are installed.
3. Run docker containers to instantiate RabbitMQ, Jaeger and the OTel Collecto. `docker-compose up` will create a cluster with three containers. You can check the status of these containers in docker desktop.
3. Open three separate terminal sessions and `cd` into each service directory (`bar`, `brewery` and `inventory`).
4. Install the dependencies in each service with `npm install`.
5. Run each service with `npm run dev` to run in dev mode (the app uses `nodemon`) or `npm start` to run in production mode.  
6. Using an API client of your choice (e.g. Postman) send a `GET` API call to `http://localhost:3001/barMenu` to fetch the whole list of beers stored in the database menu or a `GET` API call to `http://localhost:3002/newBeer` to create a new random beer and add it to the database. 

### Observability
This project showcases observability in distributed applications by using the OpenTelemetry (OTel) SDK to instrument the code, and sending the generated telemetry signals (in this case traces) to an OTel collector and from there to Jaeger backend.

The collector provides a vendor-neutral mechanism for collecting, processing, and exporting the telemetry data generated by the application, alleviating the work the it does to gather and export telemetry data, reducing overhead and separating concerns, and passing this job to the collector, so the app can focus on the business logic side. 

The `tracer.js` file in the root directory contains the OTel SDK for node.js and the required autoinstrumentation modules. The app is instrumented to collect traces from the amqplib (RabbitMQ library), http, express and mongoose modules. Notice how in each service's file (`bar`, `brewery` and `inventory`) the tracing function gets required and invoked before any other code runs.

The generated telemetry data (traces in this case) gets exported from the application using OTLP protocol. The collector receives the data via OTLP protocol, process it in batches, and export it to Jaeger backend.

The generated traces can be viewed in the Jaeger UI on `http://localhost:16686/` 
